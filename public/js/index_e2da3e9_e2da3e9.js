$(function(){var t,e,a,i=0,n={init:function(){$("#l-map").height($(window).height()-67),e=new BMap.Map("l-map"),e.centerAndZoom(new BMap.Point(116.404,39.915),14);var a={onSearchComplete:function(e){if(t.getStatus()==BMAP_STATUS_SUCCESS){var a=[];if(e.getCurrentNumPois()){$("#searchList").show();for(var i=0;i<e.getCurrentNumPois();i++)a.push('<div class="poi poi-click" data-lp='+JSON.stringify(e.getPoi(i).point)+'><div class="s-title">'+e.getPoi(i).title+'</div><div class="s-desc">'+e.getPoi(i).address+" </div></div>");$("#contentList").html(a.join(""))}else $("#searchList").show(),$("#contentList").html('<div class="poi-nodata">没有您搜索的地点</div>')}}};t=new BMap.LocalSearch(e,a)},searchLayer:function(){$(this).closest(".search").hide().siblings(".search-input").show()},hidesearchLayer:function(){$(this).closest(".search-input").hide().siblings(".search").show(),$("#contentList").html(""),$("#searchList").hide()},selectTab:function(){$(this).addClass("active").siblings().removeClass("active")},searchList:function(){var e=$(this).val();clearTimeout(window.timer),window.timer=setTimeout(function(){t.search(e)},300)},goAddress:function(){var t=$(this).data("lp");try{n.hidesearchLayer.call($(".cancel-btn")),e.centerAndZoom(new BMap.Point(t.lng,t.lat),14)}catch(a){}},pubSayLayer:function(){$("#publishLayer").show()},hidepubSayLayer:function(){$("#publishLayer").hide()},publish:function(){var t=$("#saySomething").val();if(!t||t.length>40)return alert("请输入说说");var e=$("#tab .active").text();if(!e)return alert("请选择你的现场类型");var e=$("#tab .active").text();return e?void(a.lng||a.lat?$.post("/tweets/tweets",{latitude:a.lat,longitude:a.lng,content:t,event_type:e},function(t){t&&200==t.code?(n.addMarker(),$("#publishLayer").hide()):alert("发表失败")},"json"):alert("请先定位您的位置")):alert("请选择你的现场类型")},addMarker:function(){var t=$("#shuo").html(),i=$(t);i.find("#img").attr("src","http://app.baidu.com/map/images/tiananmen.jpg"),i.find("#userName").text("用户名"),i.find("#content").text($("#saySomething").val());var n=new BMap.Point(a.lng,a.lat),o=new BMap.Marker(n),s=new BMap.InfoWindow(i.html());e.centerAndZoom(n,15),e.addControl(new BMap.ZoomControl),e.addOverlay(o),o.openInfoWindow(s),o.addEventListener("click",function(){this.openInfoWindow(s),document.getElementById("img").onload=function(){s.redraw()}})},getGeo:function(){$(this).text("定位中...").removeClass("getGeo"),n.getLocation()},getLocation:function(){var t=document.createElement("lbs-geo");t.addEventListener("geofail",function(){$(".get-geo").text("获取定位失败"),++i<=3&&$(".get-geo").addClass("getGeo")}),t.addEventListener("geosuccess",function(t){var e=t.detail.coords;a={lng:e.lng,lat:e.lat},$("#geo").hide(),n.searchNearBy(t.detail.address),$(".get-geo").text(t.detail.address).addClass("showList")}),t.setAttribute("enable-modified","true"),t.setAttribute("id","geo"),document.body.appendChild(t)},searchSayPoint:function(){a=$(this).data("lp"),$(".get-geo").text($(this).find(".s-title").text()),n.hideList()},showList:function(){$("#selectNearyBy").show()},hideList:function(){$("#selectNearyBy").hide()},searchNearBy:function(t){e.centerAndZoom(new BMap.Point(a.lng,a.lat),14);var i={onSearchComplete:function(t){if(n.getStatus()==BMAP_STATUS_SUCCESS){var e=[];$("#selectNearyBy").show();for(var a=0;a<t.getCurrentNumPois();a++)e.push('<div class="poi search-poi-click" data-lp='+JSON.stringify(t.getPoi(a).point)+'><div class="s-title">'+t.getPoi(a).title+'</div><div class="s-desc">'+t.getPoi(a).address+" </div></div>");$("#nearBycontentList").html(e.join(""))}}},n=new BMap.LocalSearch(e,i);n.search(t)}};n.init(),$(document).on("tap",".search-btn",n.searchLayer).on("tap",".cancel-btn",n.hidesearchLayer).on("tap",".tab .item",n.selectTab).on("input","#searchInput",n.searchList).on("tap",".poi-click",n.goAddress).on("tap",".pubSay",n.pubSayLayer).on("tap",".cancel-publish",n.hidepubSayLayer).on("tap",".publish",n.publish).on("tap",".getGeo",n.getGeo).on("tap",".showList",n.showList).on("tap",".go-back",n.hideList).on("tap",".search-poi-click",n.searchSayPoint)});